<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri Wiz - Crop Recommendation System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .recommendation-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px 0 rgba(31, 38, 135, 0.45);
        }

        .loading {
            display: none;
        }
        .loading.active {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .navbar {
            background: rgba(25, 135, 84, 0.25) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #000;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
        }

        .table {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .table thead {
            background: rgba(255, 255, 255, 0.1);
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            background: rgba(255, 255, 255, 0.05);
        }

        .alert-info {
            background: rgba(13, 202, 240, 0.15);
            border: 1px solid rgba(13, 202, 240, 0.2);
            color: #fff;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        h2, h3, h4, h5, .nav-link, .navbar-brand {
            color: #fff !important;
        }

        label {
            color: #fff;
        }

        .btn-primary {
            background: rgba(13, 110, 253, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .btn-success {
            background: rgba(25, 135, 84, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }

        .mt-4 {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-seedling"></i> Agri Wiz</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#recommendations">Recommendations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#yieldEstimation">Yield Estimation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#schemes">Govt. Schemes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#crops">Manage Crops</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="recommendations">
            <h2 class="mb-4">Get Crop Recommendations</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Location-based Recommendation</h5>
                            <form id="locationForm">
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="location" required>
                                        <button type="button" class="btn btn-secondary" id="getLocationBtn">
                                            <i class="fas fa-location-dot"></i> Get My Location
                                        </button>
                                    </div>
                                    <div id="locationStatus" class="form-text text-light"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Humidity (Optional)</label>
                                    <select class="form-select" id="locationHumidity">
                                        <option value="">Select humidity</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Soil Fertility (Optional)</label>
                                    <select class="form-select" id="locationSoilFertility">
                                        <option value="">Select soil fertility</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Get Recommendations</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Custom Parameters</h5>
                            <form id="customForm">
                                <div class="mb-3">
                                    <label class="form-label">Soil Type</label>
                                    <select class="form-select" id="soilType" required>
                                        <option value="">Select soil type</option>
                                        <option value="clay">Clay</option>
                                        <option value="loamy">Loamy</option>
                                        <option value="sandy">Sandy</option>
                                        <option value="black soil">Black Soil</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Climate</label>
                                    <select class="form-select" id="climate" required>
                                        <option value="">Select climate</option>
                                        <option value="tropical">Tropical</option>
                                        <option value="subtropical">Subtropical</option>
                                        <option value="temperate">Temperate</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Season</label>
                                    <select class="form-select" id="season" required>
                                        <option value="">Select season</option>
                                        <option value="summer">Summer</option>
                                        <option value="winter">Winter</option>
                                        <option value="rainy">Rainy</option>
                                        <option value="spring">Spring</option>
                                        <option value="fall">Fall</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rainfall (Optional)</label>
                                    <select class="form-select" id="rainfall">
                                        <option value="">Select rainfall</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Humidity (Optional)</label>
                                    <select class="form-select" id="humidity">
                                        <option value="">Select humidity</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Soil Fertility (Optional)</label>
                                    <select class="form-select" id="soilFertility">
                                        <option value="">Select soil fertility</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Get Recommendations</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="recommendationsResult" class="mt-4" style="display: none;">
                <h3>Recommendations</h3>
                <div id="weatherInfo" class="alert alert-info" style="display: none;"></div>
                <div class="row" id="recommendationCards"></div>
            </div>
        </div>

        <div id="yieldEstimation" class="mt-5">
            <h2>Yield Estimation</h2>
            <div class="card glass-effect">
                <div class="card-body">
                    <form id="yieldEstimationForm" onsubmit="estimateYield(event)">
                        <div class="mb-3">
                            <label class="form-label">Crop</label>
                            <select class="form-select" id="yieldCrop" required>
                                <option value="">Select crop</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Temperature (°C)</label>
                                    <input type="number" class="form-control" id="yieldTemp" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Rainfall (mm)</label>
                                    <input type="number" class="form-control" id="yieldRainfall" step="0.1" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Humidity (%)</label>
                                    <input type="number" class="form-control" id="yieldHumidity" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Soil pH</label>
                                    <input type="number" class="form-control" id="yieldSoilPh" value="6.5" step="0.1" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Soil Fertility</label>
                                    <select class="form-select" id="yieldSoilFertility" required>
                                        <option value="">Select fertility</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Water Availability</label>
                                    <select class="form-select" id="yieldWater" required>
                                        <option value="">Select availability</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Season</label>
                                    <select class="form-select" id="yieldSeason">
                                        <option value="summer">Summer</option>
                                        <option value="winter">Winter</option>
                                        <option value="rainy">Rainy</option>
                                        <option value="spring">Spring</option>
                                        <option value="fall">Fall</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-secondary" onclick="autofillYieldParams()">
                                Auto-fill from Location
                            </button>
                            <button type="submit" class="btn btn-primary">Estimate Yield</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="yieldResults" class="mt-4" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card glass-effect mb-3">
                            <div class="card-body">
                                <h4>Estimated Yield</h4>
                                <div id="yieldEstimate"></div>
                                <div id="yieldConfidence" class="text-muted"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card glass-effect mb-3">
                            <div class="card-body">
                                <h4>Yield Factors</h4>
                                <div id="yieldFactors"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card glass-effect">
                    <div class="card-body">
                        <h4>Optimization Suggestions</h4>
                        <div id="yieldOptimization"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="crops" class="mt-5">
            <h2 class="mb-4">Manage Crops</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addCropModal">
                <i class="fas fa-plus"></i> Add New Crop
            </button>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Crop Name</th>
                            <th>Soil Types</th>
                            <th>Climates</th>
                            <th>Seasons</th>
                            <th>Water Needs</th>
                            <th>Humidity</th>
                            <th>Soil Fertility</th>
                        </tr>
                    </thead>
                    <tbody id="cropsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="schemes" class="mt-5">
            <h2>Agricultural Schemes</h2>
            <div class="card glass-effect">
                <div class="card-body">
                    <form id="schemesSearchForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Search By</label>
                                    <select class="form-select" id="schemeSearchType" onchange="updateSchemeSearchForm()">
                                        <option value="category">Category</option>
                                        <option value="crop">Crop & Location</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8" id="categorySearch">
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="schemeCategory">
                                        <option value="">Loading categories...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8" id="cropSearch" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Crop</label>
                                            <select class="form-select" id="schemeCrop">
                                                <option value="">Select crop</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">State</label>
                                            <input type="text" class="form-control" id="schemeState">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Land Area (ha)</label>
                                            <input type="number" class="form-control" id="schemeLandArea" step="0.1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Search Schemes</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="schemeResults" class="mt-4" style="display: none;">
                <div class="row" id="schemeCards"></div>
            </div>
        </div>

    </div>

    <!-- Add Crop Modal -->
    <div class="modal fade" id="addCropModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Crop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCropForm">
                        <div class="mb-3">
                            <label class="form-label">Crop Name</label>
                            <input type="text" class="form-control" id="cropName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Soil Types (comma-separated)</label>
                            <input type="text" class="form-control" id="cropSoilTypes" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Climates (comma-separated)</label>
                            <input type="text" class="form-control" id="cropClimates" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Seasons (comma-separated)</label>
                            <input type="text" class="form-control" id="cropSeasons" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Water Needs</label>
                            <select class="form-select" id="cropWaterNeeds" required>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Humidity Preference (comma-separated)</label>
                            <input type="text" class="form-control" id="cropHumidity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Soil Fertility (comma-separated)</label>
                            <input type="text" class="form-control" id="cropSoilFertility" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCropBtn">Save Crop</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show loading spinner
        function showLoading() {
            document.querySelector('.loading').classList.add('active');
        }

        // Hide loading spinner
        function hideLoading() {
            document.querySelector('.loading').classList.remove('active');
        }

        // Load crops table
        async function loadCrops() {
            try {
                showLoading();
                const response = await fetch('/api/crops');
                const crops = await response.json();
                const tbody = document.getElementById('cropsTableBody');
                tbody.innerHTML = '';
                
                crops.forEach(crop => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${crop.crop_name}</td>
                        <td>${crop.soil_types}</td>
                        <td>${crop.climates}</td>
                        <td>${crop.seasons}</td>
                        <td>${crop.water_needs}</td>
                        <td>${crop.humidity_preference}</td>
                        <td>${crop.soil_fertility}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                alert('Error loading crops: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display recommendations
        function displayRecommendations(recommendations, weatherInfo = null) {
            const resultDiv = document.getElementById('recommendationsResult');
            const cardsDiv = document.getElementById('recommendationCards');
            const weatherInfoDiv = document.getElementById('weatherInfo');
            
            resultDiv.style.display = 'block';
            cardsDiv.innerHTML = '';
            
            if (weatherInfo) {
                weatherInfoDiv.style.display = 'block';
                weatherInfoDiv.innerHTML = `
                    <h4>Location Information:</h4>
                    <p>
                        Soil Type: ${weatherInfo.soil_type || 'N/A'}<br>
                        Climate: ${weatherInfo.climate || 'N/A'}<br>
                        Season: ${weatherInfo.season || 'N/A'}<br>
                        Rainfall: ${weatherInfo.rainfall || 'N/A'}<br>
                        Humidity: ${weatherInfo.humidity || 'N/A'}<br>
                        Soil Fertility: ${weatherInfo.soil_fertility || 'N/A'}
                    </p>
                `;
            } else {
                weatherInfoDiv.style.display = 'none';
            }

            if (recommendations && recommendations.length > 0) {
                recommendations.forEach(crop => {
                    if (!crop) return; // Skip undefined entries
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-4 mb-4';
                    col.innerHTML = `
                        <div class="card recommendation-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${crop.crop_name || 'Unknown Crop'}</h5>
                                <p class="card-text">
                                    <strong>Water Needs:</strong> ${crop.water_needs || 'N/A'}<br>
                                    <strong>Humidity:</strong> ${crop.humidity_preference || 'N/A'}<br>
                                    <strong>Soil Fertility:</strong> ${crop.soil_fertility || 'N/A'}<br>
                                    <strong>Soil Types:</strong> ${crop.soil_types || 'N/A'}<br>
                                    <strong>Climates:</strong> ${crop.climates || 'N/A'}<br>
                                    <strong>Seasons:</strong> ${crop.seasons || 'N/A'}
                                </p>
                            </div>
                        </div>
                    `;
                    cardsDiv.appendChild(col);
                });
            } else {
                cardsDiv.innerHTML = '<div class="col-12"><div class="alert alert-info">No crop recommendations found for the given criteria. Try adjusting your parameters.</div></div>';
            }
        }

        // Form submission handlers
        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                showLoading();
                const response = await fetch('/api/recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: document.getElementById('location').value,
                        humidity: document.getElementById('locationHumidity').value || undefined,
                        soil_fertility: document.getElementById('locationSoilFertility').value || undefined
                    })
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                displayRecommendations(data.recommendations, data.details);
            } catch (error) {
                alert('Error getting recommendations: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('customForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                showLoading();
                const response = await fetch('/api/recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        soil_type: document.getElementById('soilType').value,
                        climate: document.getElementById('climate').value,
                        season: document.getElementById('season').value,
                        rainfall: document.getElementById('rainfall').value || undefined,
                        humidity: document.getElementById('humidity').value || undefined,
                        soil_fertility: document.getElementById('soilFertility').value || undefined
                    })
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                displayRecommendations(data.recommendations);
            } catch (error) {
                alert('Error getting recommendations: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Add crop form handler
        document.getElementById('saveCropBtn').addEventListener('click', async () => {
            try {
                showLoading();
                const response = await fetch('/api/crops', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        crop_name: document.getElementById('cropName').value,
                        soil_types: document.getElementById('cropSoilTypes').value,
                        climates: document.getElementById('cropClimates').value,
                        seasons: document.getElementById('cropSeasons').value,
                        water_needs: document.getElementById('cropWaterNeeds').value,
                        humidity_preference: document.getElementById('cropHumidity').value,
                        soil_fertility: document.getElementById('cropSoilFertility').value
                    })
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('addCropModal')).hide();
                document.getElementById('addCropForm').reset();
                
                // Reload crops table
                await loadCrops();
            } catch (error) {
                alert('Error adding crop: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Geolocation functions
        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.address.city || data.address.town || data.address.village || data.address.suburb || data.address.county;
            } catch (error) {
                console.error('Error getting location name:', error);
                return null;
            }
        }

        document.getElementById('getLocationBtn').addEventListener('click', () => {
            const statusEl = document.getElementById('locationStatus');
            statusEl.textContent = 'Getting your location...';

            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation is not supported by your browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const locationName = await getLocationName(latitude, longitude);
                
                if (locationName) {
                    document.getElementById('location').value = locationName;
                    statusEl.textContent = 'Location found!';
                } else {
                    statusEl.textContent = 'Could not determine location name. Please enter manually.';
                }
            }, (error) => {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        statusEl.textContent = "Location permission denied";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        statusEl.textContent = "Location information unavailable";
                        break;
                    case error.TIMEOUT:
                        statusEl.textContent = "Location request timed out";
                        break;
                    default:
                        statusEl.textContent = "An unknown error occurred";
                        break;
                }
            });
        });

        // Initialize yield estimation
        async function initYieldEstimation() {
            const yieldCrop = document.getElementById('yieldCrop');
            try {
                const response = await fetch('/api/crops');
                const crops = await response.json();
                yieldCrop.innerHTML = '<option value="">Select crop</option>' +
                    crops.map(crop => `<option value="${crop.crop_name}">${crop.crop_name}</option>`).join('');
            } catch (error) {
                console.error('Error loading crops:', error);
            }
        }

        // Auto-fill yield parameters from location
        async function autofillYieldParams() {
            const location = document.getElementById('location').value;
            if (!location) {
                alert('Please enter a location first');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/api/weather/${encodeURIComponent(location)}`);
                const weather = await response.json();

                if (weather.error) {
                    throw new Error(weather.error);
                }

                document.getElementById('yieldTemp').value = weather.temperature;
                document.getElementById('yieldRainfall').value = weather.rainfall;
                document.getElementById('yieldHumidity').value = weather.humidity;
                document.getElementById('yieldSeason').value = weather.season;
            } catch (error) {
                alert('Error fetching weather data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Estimate yield
        async function estimateYield(event) {
            event.preventDefault();
            
            const data = {
                crop_name: document.getElementById('yieldCrop').value,
                temperature: document.getElementById('yieldTemp').value,
                rainfall: document.getElementById('yieldRainfall').value,
                humidity: document.getElementById('yieldHumidity').value,
                soil_ph: document.getElementById('yieldSoilPh').value,
                soil_fertility: document.getElementById('yieldSoilFertility').value,
                water_availability: document.getElementById('yieldWater').value,
                season: document.getElementById('yieldSeason').value
            };

            try {
                showLoading();
                const response = await fetch('/api/yield/estimate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }

                // Display results
                document.getElementById('yieldResults').style.display = 'block';
                
                // Show yield estimate
                document.getElementById('yieldEstimate').innerHTML = 
                    `<h2 class="display-4">${result.estimated_yield} ${result.unit}</h2>`;
                document.getElementById('yieldConfidence').innerHTML = 
                    `Confidence Interval: ${result.confidence_interval[0]} - ${result.confidence_interval[1]} ${result.unit}`;
                
                // Show yield factors
                if (result.factors && result.factors.factors) {
                    const factorsHtml = Object.entries(result.factors.factors)
                        .map(([factor, importance]) => 
                            `<div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${factor.replace(/_/g, ' ')}</span>
                                <div class="progress" style="width: 60%">
                                    <div class="progress-bar" role="progressbar" 
                                        style="width: ${importance}%" 
                                        aria-valuenow="${importance}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                        ${importance}%
                                    </div>
                                </div>
                            </div>`
                        ).join('');
                    document.getElementById('yieldFactors').innerHTML = factorsHtml;
                }
                
                // Show optimization suggestions
                if (result.optimization && result.optimization.suggestions) {
                    const suggestionsHtml = result.optimization.suggestions
                        .map(suggestion => 
                            `<div class="alert alert-info">
                                <strong>${suggestion.suggestion}</strong><br>
                                Potential improvement: +${suggestion.potential_improvement} ${result.unit}
                            </div>`
                        ).join('');
                    document.getElementById('yieldOptimization').innerHTML = suggestionsHtml;
                }

            } catch (error) {
                alert('Error estimating yield: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Initialize scheme categories
        async function initSchemeCategories() {
            try {
                const response = await fetch('/api/schemes/categories');
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                const categorySelect = document.getElementById('schemeCategory');
                categorySelect.innerHTML = '<option value="">Select category</option>' +
                    data.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } catch (error) {
                console.error('Error loading scheme categories:', error);
            }
        }

        // Update scheme search form based on search type
        function updateSchemeSearchForm() {
            const searchType = document.getElementById('schemeSearchType').value;
            document.getElementById('categorySearch').style.display = 
                searchType === 'category' ? 'block' : 'none';
            document.getElementById('cropSearch').style.display = 
                searchType === 'crop' ? 'block' : 'none';
        }

        // Handle scheme search
        document.getElementById('schemesSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const searchType = document.getElementById('schemeSearchType').value;
            
            try {
                showLoading();
                const response = await fetch('/api/schemes/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(
                        searchType === 'category' 
                        ? {
                            search_type: 'category',
                            category: document.getElementById('schemeCategory').value
                        }
                        : {
                            search_type: 'crop',
                            crop: document.getElementById('schemeCrop').value,
                            state: document.getElementById('schemeState').value,
                            land_area: document.getElementById('schemeLandArea').value
                        }
                    )
                });

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                displaySchemes(data);
            } catch (error) {
                alert('Error searching schemes: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Display schemes
        function displaySchemes(data) {
            const resultDiv = document.getElementById('schemeResults');
            const cardsDiv = document.getElementById('schemeCards');
            
            resultDiv.style.display = 'block';
            cardsDiv.innerHTML = '';

            const schemes = data.schemes || [];
            if (schemes.length === 0) {
                cardsDiv.innerHTML = '<div class="col-12"><div class="alert alert-info">No schemes found matching your criteria.</div></div>';
                return;
            }

            schemes.forEach(scheme => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                
                let benefitsHtml = '';
                if (scheme.benefits && scheme.benefits.length > 0) {
                    benefitsHtml = `
                        <h6>Benefits:</h6>
                        <ul>
                            ${scheme.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                        </ul>
                    `;
                }

                let subsidiesHtml = '';
                if (data.subsidies) {
                    subsidiesHtml = `
                        <h6>Available Subsidies:</h6>
                        <ul>
                            ${Object.entries(data.subsidies)
                                .filter(([_, value]) => value)
                                .map(([category, subsidy]) => 
                                    `<li><strong>${category}:</strong> ${subsidy}</li>`
                                ).join('')}
                        </ul>
                    `;
                }

                col.innerHTML = `
                    <div class="card scheme-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${scheme.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${scheme.full_name || ''}</h6>
                            <p class="card-text">${scheme.description}</p>
                            ${benefitsHtml}
                            ${subsidiesHtml}
                        </div>
                    </div>
                `;
                cardsDiv.appendChild(col);
            });
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCrops();
            initYieldEstimation();
            initSchemeCategories();
            
            // Also populate scheme crop dropdown
            const schemeCrop = document.getElementById('schemeCrop');
            fetch('/api/crops')
                .then(response => response.json())
                .then(crops => {
                    schemeCrop.innerHTML = '<option value="">Select crop</option>' +
                        crops.map(crop => `<option value="${crop.crop_name}">${crop.crop_name}</option>`).join('');
                })
                .catch(error => console.error('Error loading crops for schemes:', error));
        });
    </script>
</body>
</html>